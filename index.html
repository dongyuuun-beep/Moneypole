<div class="filter-section">
    <input type="text" id="searchInput" class="search-input" placeholder="은행명 또는 상품명 검색...">
    <div style="display:flex; justify-content:space-between; font-size:13px; color:#666;">
        <label><input type="checkbox" id="baseOnly"> 우대금리 제외</label>
        <div id="termFilterContainer">
            <select id="termSelect" style="border:none; background:none; font-weight: bold; color: var(--primary);" onchange="renderList()">
                <option value="all">전체 기간</option>
                <option value="6">6개월</option>
                <option value="12" selected>12개월</option>
                <option value="24">24개월</option>
                <option value="36">36개월</option>
            </select>
        </div>
    </div>
</div>

<script>
    let allData = []; 
    let currentItem = null; 
    let currentType = 'deposit'; 

    // 데이터 로드
    fetch('data.json').then(res => res.json()).then(data => {
        allData = data;
        renderList();
    }).catch(err => console.error("데이터 로드 실패:", err));

    function renderList() {
        const listArea = document.getElementById('listArea');
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const isBaseOnly = document.getElementById('baseOnly').checked;
        const termFilter = document.getElementById('termSelect').value; 
        
        // [수정] 1. CMA/파킹통장 탭일 때 기간 필터 UI 삭제(숨김)
        const filterWrap = document.getElementById('termFilterContainer');
        if (currentType === 'cma' || currentType === 'parking') {
            filterWrap.style.display = 'none';
        } else {
            filterWrap.style.display = 'block';
        }

        listArea.innerHTML = '';
        if (!allData || allData.length === 0) return;

        // 2. 현재 탭 유형(예/적금 등)에 맞는 데이터만 필터링
        let filtered = allData.filter(d => d.type === currentType);

        // [수정] 3. 중복 노출 방지: 같은 은행/상품명 중 금리가 가장 높은 하나만 남김
        const uniqueProducts = {};
        filtered.forEach(item => {
            const key = item.bank + item.name;
            if (!uniqueProducts[key] || uniqueProducts[key].max < item.max) {
                uniqueProducts[key] = item;
            }
        });
        filtered = Object.values(uniqueProducts);

        // 4. 기간 필터링 (예적금만 해당)
        if (termFilter !== 'all' && currentType !== 'cma' && currentType !== 'parking') {
            filtered = filtered.filter(d => {
                if (d.options) return d.options.some(o => String(o.save_trm) === termFilter);
                return String(d.save_trm) === termFilter;
            });
        }

        // 5. 검색어 및 정렬
        if (keyword) {
            filtered = filtered.filter(d => d.bank.includes(keyword) || d.name.includes(keyword));
        }
        filtered.sort((a,b) => (isBaseOnly ? b.base : b.max) - (isBaseOnly ? a.base : a.max));

        // 카드 렌더링
        filtered.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="bank-tag">${item.bank} | ${item.save_trm}개월</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:600;">${item.name}</div>
                    <div class="rate-main">${(isBaseOnly ? item.base : item.max).toFixed(2)}%</div>
                </div>
            `;
            card.onclick = () => openDetail(item);
            listArea.appendChild(card);
        });
    }

    function openDetail(item) {
        currentItem = item;
        const detailView = document.getElementById('detailView');
        detailView.style.display = 'block';
        document.body.classList.add('modal-open');
        
        document.getElementById('detailBank').innerText = item.bank;
        document.getElementById('detailName').innerText = item.name;

        // [수정] 상세창 기간 드롭다운 중복 제거 (12개월이 두 번 나오던 문제 해결)
        const calcTermSelect = document.getElementById('calcTermSelect');
        calcTermSelect.innerHTML = '';
        
        if (item.options && item.options.length > 0 && currentType !== 'cma' && currentType !== 'parking') {
            calcTermSelect.style.display = 'block';
            const seen = new Set();
            const uniqueOptions = item.options.filter(opt => {
                const isDuplicate = seen.has(opt.save_trm);
                seen.add(opt.save_trm);
                return !isDuplicate;
            }).sort((a,b) => a.save_trm - b.save_trm);

            uniqueOptions.forEach(opt => {
                const optionEl = document.createElement('option');
                optionEl.value = JSON.stringify(opt);
                optionEl.innerText = `${opt.save_trm}개월 (최고 연 ${opt.intr_rate2.toFixed(2)}%)`;
                if (opt.save_trm === item.save_trm) optionEl.selected = true;
                calcTermSelect.appendChild(optionEl);
            });
        } else {
            calcTermSelect.style.display = 'none';
        }

        // 초기 금리 표시 및 계산 실행
        updateDetailDisplay(item.base, item.max, item.save_trm);
        doCalc();
    }

    function updateDetailDisplay(base, max, term) {
        document.getElementById('detailBaseRate').innerText = `기본 연 ${base.toFixed(2)}%`;
        document.getElementById('detailRate').innerText = `최고 연 ${max.toFixed(2)}%`;
        document.getElementById('detailTermTag').innerText = `${term}개월 기준`;
    }

    function doCalc() {
        const val = parseFloat(document.getElementById('calcInput').value);
        const calcTermSelect = document.getElementById('calcTermSelect');
        
        let months = currentItem.save_trm;
        let baseR = currentItem.base;
        let maxR = currentItem.max;

        if (calcTermSelect && calcTermSelect.style.display !== 'none' && calcTermSelect.value) {
            const opt = JSON.parse(calcTermSelect.value);
            months = opt.save_trm;
            baseR = opt.intr_rate;
            maxR = opt.intr_rate2;
            updateDetailDisplay(baseR, maxR, months);
        }

        if(!val || isNaN(val)) return;
        // ... (이후 계산 로직은 기존과 동일) ...
    }

    // 탭 클릭 이벤트
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentType = btn.dataset.type;
            renderList();
        };
    });
</script>
